<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lgy.project_book_store.dao.SearchDAO">

	<!-- 키워드로 책 검색 -->
	<select id="searchBooks" parameterType="string"
		resultType="com.lgy.project_book_store.dto.SearchDTO">
		SELECT
		b.book_id AS bookId,
		b.book_title AS bookTitle,
		b.book_writer AS bookWriter,
		b.book_pub AS bookPub,
		b.book_date AS
		bookDate,
		b.genre_id AS genreId,
		g.genre_name AS genreName,
		b.book_price
		AS bookPrice,
		b.book_count AS bookCount,
		b.book_comm AS bookComm,
		b.book_isbn AS bookIsbn,
		b.book_image_path AS bookImagePath
		FROM Book b
		LEFT JOIN Genre g ON b.genre_id = g.genre_id
		WHERE LOWER(b.book_title)
		LIKE CONCAT('%', LOWER(#{keyword}), '%')
		OR LOWER(b.book_writer) LIKE
		CONCAT('%', LOWER(#{keyword}), '%')
		ORDER BY b.book_id ASC
	</select>

	<!-- 전체 책 리스트 -->
	<select id="getBookList"
		resultType="com.lgy.project_book_store.dto.SearchDTO">
		SELECT
		b.book_id AS bookId,
		b.book_title AS bookTitle,
		b.book_writer AS bookWriter,
		b.book_pub AS bookPub,
		b.book_date AS
		bookDate,
		b.genre_id AS genreId,
		g.genre_name AS genreName,
		b.book_price
		AS bookPrice,
		b.book_count AS bookCount,
		b.book_comm AS bookComm,
		b.book_isbn AS bookIsbn,
		b.book_image_path AS bookImagePath
		FROM Book b
		LEFT JOIN Genre g ON b.genre_id = g.genre_id
		ORDER BY b.book_id ASC
	</select>

	<!-- 단일 책 조회 -->
	<select id="getBookById" parameterType="int"
		resultType="com.lgy.project_book_store.dto.SearchDTO">
		SELECT
		b.book_id AS bookId,
		b.book_title AS bookTitle,
		b.book_writer AS bookWriter,
		b.book_pub AS bookPub,
		b.book_date AS
		bookDate,
		b.genre_id AS genreId,
		g.genre_name AS genreName,
		b.book_price
		AS bookPrice,
		b.book_count AS bookCount,
		b.book_comm AS bookComm,
		b.book_isbn AS bookIsbn,
		b.book_image_path AS bookImagePath
		FROM Book b
		LEFT JOIN Genre g ON b.genre_id = g.genre_id
		WHERE b.book_id =
		#{bookId}
	</select>

	<!-- 검색어 + 장르 필터 -->
	<select id="searchBooksByTitleAndGenre"
		resultType="com.lgy.project_book_store.dto.SearchDTO">
		SELECT
		b.book_id AS bookId,
		b.book_title AS bookTitle,
		b.book_writer AS bookWriter,
		b.book_pub AS bookPub,
		b.book_date AS bookDate,
		b.genre_id AS genreId,
		g.genre_name AS genreName,
		b.book_price AS bookPrice,
		b.book_count AS bookCount,
		b.book_comm AS bookComm,
		b.book_isbn AS bookIsbn,
		b.book_image_path AS bookImagePath
		FROM Book b
		LEFT JOIN Genre g ON b.genre_id = g.genre_id
		WHERE 1=1
		<if test="q != null and q != ''">
			AND (LOWER(b.book_title) LIKE '%' || LOWER(#{q}) || '%'
			OR LOWER(b.book_writer) LIKE '%' || LOWER(#{q}) || '%')
		</if>
		<if test="genreId != null">
			AND b.genre_id = #{genreId}
		</if>
		ORDER BY b.book_id ASC
	</select>



	<!-- 장르 목록 조회 -->
	<select id="getGenreList"
		resultType="com.lgy.project_book_store.dto.GenreDTO">
		SELECT
		genre_id AS genreId,
		genre_name AS genreName
		FROM Genre
		ORDER BY genre_id ASC
	</select>

</mapper>
